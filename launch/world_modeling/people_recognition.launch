<?xml version="1.0"?>
<launch>

    <!-- Get the machine file -->
    <arg name="machine" default="localhost"/>
    <include file="$(env ROBOT_BRINGUP_PATH)/machines/$(arg machine).machine" />

    <arg name="robot_env" default="$(optenv ROBOT_ENV robotics_testlabs)" />
    <arg name="robot_real" default="$(optenv ROBOT_REAL false)" />
    <arg name="robot_name"/>

    <!-- People recognition 3D node args -->
    <arg name="probability_threshold" default="0.2" />
    <arg name="link_threshold" default="0.5" />
    <arg name="heuristic" default="head" />
    <arg name="arm_norm_threshold" default="0.5" />
    <arg name="neck_norm_threshold" default="0.7" />
    <arg name="wave_threshold" default="0.2" />
    <arg name="vert_threshold" default="0.7" />
    <arg name="hor_threshold" default="0.4" />
    <arg name="padding" default="5" />
    <arg name="enable_topic_mode" default="False" />
    <arg name="camera_info_depth" default="/$(arg robot_name)/head_rgbd_sensor/depth_registered/camera_info" />
    <arg name="image_depth" default="/$(arg robot_name)/head_rgbd_sensor/depth_registered/image" />
    <arg name="image_rgb" default="/$(arg robot_name)/head_rgbd_sensor/rgb/image_raw" />

    <!-- People recognition 2D node args -->
    <arg name="color_extractor_srv_name" default="/$(arg robot_name)/people_recognition/extract_color" />
    <arg name="openface_srv_name" default="face_recognition/recognize" />
    <arg name="openpose_srv_name" default="/$(arg robot_name)/openpose/recognize" />
    <arg name="keras_srv_name" default="face_recognition/get_face_properties" />

    <arg name="openface_db" default="" />
    <arg name="openface_config" default="$(env ROBOT_BRINGUP_PATH)/parameters/world_modeling/face_recognition.yaml" />
    <arg name="keras_face_model" default="~/data/keras_models/age_gender/weights.28-3.73.hdf5" />

    <!-- People recognition -->
    <group ns="people_recognition">

        <!-- People recognition 3D-->
        <node name="people_recognition_3d_node" pkg="people_recognition_3d" type="people_recognition_3d_node" output="log" machine="$(arg machine)" >
            <param name="probability_threshold" value="$(arg probability_threshold)" />
            <param name="link_threshold" value="$(arg link_threshold)" />
            <param name="heuristic" value="$(arg heuristic)" />
            <param name="arm_norm_threshold" value="$(arg arm_norm_threshold)" />
            <param name="neck_norm_threshold" value="$(arg neck_norm_threshold)"/>
            <param name="wave_threshold" value="$(arg wave_threshold)" />
            <param name="vert_threshold" value="$(arg vert_threshold)" />
            <param name="hor_threshold" value="$(arg hor_threshold)" />
            <param name="padding" value="$(arg padding)" />
            <param name="enable_topic_mode" value="$(arg enable_topic_mode)" />
            <param name="camera_info_depth" value="$(arg camera_info_depth)" />
            <param name="image_depth" value="$(arg image_depth)" />
            <param name="image_rgb" value="$(arg image_rgb)" />
        </node>

        <!-- People recognition 2D-->
        <node name="people_recognition_2d_node" pkg="people_recognition_2d" type="people_recognition_2d_node" output="log" machine="$(arg machine)" >
            <param name="color_extractor_srv_name" value="$(arg color_extractor_srv_name)" />
            <param name="openface_srv_name" value="$(arg openface_srv_name)" />
            <param name="openpose_srv_name" value="$(arg openpose_srv_name)" />
            <param name="keras_srv_name" value="$(arg keras_srv_name)" />
        </node>

        <!-- Face recognition -->
        <group ns="face_recognition" >
            <!-- OpenFace detection -->
            <node name="face_recognition" pkg="image_recognition_openface" type="face_recognition_node" output="log" machine="$(arg machine)">
                <rosparam command="load" file="$(arg openface_config)" />
                <param name="topic_save_images" value="false" />
                <param name="service_save_images" value="$(arg robot_real)" />
                <param name="save_images_folder" value="~/MEGA/data/$(arg robot_env)/training_data" />
                <param name="db" value="$(arg openface_db)" />
            </node>

            <!-- Keras face properties -->
            <node pkg="image_recognition_keras" type="face_properties_node" name="keras_face_properties">
                <param name="weights_file_path" value="$(arg keras_face_model)" />
                <param name="save_images" value="$(arg robot_real)" />
                <param name="save_images_folder" value="~/MEGA/data/$(arg robot_env)/training_data" />
            </node>
        </group>

        <!-- Colour extraction -->
        <node pkg="image_recognition_util" type="color_extractor_node" name="color_extractor_node" />
    </group>

</launch>
